---
title: "Tölvuverkefni 3"
author: "Ásmundur Óskar Ásmundsson (aoa27@hi.is) og Helgi Sigtryggsson (hes86@hi.is)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r pakkar, include=FALSE}
library(readr)
library(dplyr)
library(lubridate)
library(ggplot2)
library(kableExtra)
library(tidyr)
library(reshape2)
```

## a) liður
Byrjum á því að lesa inn gögnin:
```{r, lesa gögn}
ah <- read.csv("data98.csv", sep=",")
```

```{r, búum til nýjar breytur}
r2d <-
function(r)
{
	lat <- floor(r/100)
	lon <- (r - lat * 100) %% 50
	halfb <- (r - 100 * lat - lon)/100
	lon <-  - (lon + 0.5)
	lat <- lat + 60 + halfb + 0.25
	data.frame(lat = lat, lon = lon)
}
latitude<- r2d(ah$reit)$lat
longtitude <- r2d(ah$reit)$lon
hafsvaedi <- ifelse(latitude < 65, 
                    ifelse(longtitude < -19, "SV","SA"),
                    ifelse(longtitude < -19, "NV","NAu")
                    )
kt2 <- ifelse(ah$kt == 1, "Ókynþroska", "Kynþroska")
ah <- ah %>%
  mutate(hafsvaedi = factor(hafsvaedi), 
         kt2 = factor(kt2)
         )
```


## b) liður
```{r, tafla fyrir fjölda fiska af hvoru kynþroskastigi eftir hafsvæðum}
taflab <- ah %>%
  group_by("Hafsvæði" = hafsvaedi,kt2) %>%
  count(kt2, name="Fjöldi")
taflab
```

```{r, tafla sem sýnir kynþroskahlutfall á hverju hafsvæði}
c <- vector()
f <- vector()
for (i in 1:4)
  c[i] = taflab$Fjöldi[2*i-1]+taflab$Fjöldi[2*i]
for (i in 1:8)
  f[i] = taflab$Fjöldi[i]/c[ceiling(i/2)]
taflab[ , "Hlutfall"] <- f
taflab
```
```{r, Mynd sem er lýsandi fyrir fjölda fiska af hvoru kynþroskastigi í hverjum flokki af hafsvæðunum fjórum}
ggplot(ah, aes(hafsvaedi, fill=kt2)) + geom_bar(position='dodge') +
xlab("Hafsvæði") + ylab("Fjöldi")
```

## c) liður
```{r, tafla sem sýnir fjölda fiska, meðallengd, meðalþyngd og staðalfrávik lengdar eftir aldri}
taflac <- ah %>%
  group_by(aldur) %>%
  summarise("Fjöldi fiska" = length(aldur),"Meðallengd" = mean(le), "Meðalþyngd" =mean(osl), "Staðalfrávik lengdar" = sd(le)) #%>% kable(align = "lllll") %>%
  #kable_styling()
taflac
```
Úr töflunni má lesa að flestir fiskar eru þriggja til sex ára. Fáir fiskar eru yngri en þriggja ára og fiskum eldri en sex ára fer hratt minnkandi. Þá eykst lengd fiskanna með hækkandi aldri og dreifnin á gildi lengda verður meiri með hækkandi aldri. Þá þyngjast fiskarnir með hækkandi aldri.

```{r, Mynd sem sýnir lengd fiska eftir aldri}
  ggplot(ah, aes(x = aldur, y = le)) + labs(
        title = "Graf sem sýnir lengd fiska eftir aldri",
        x = "Aldur",
        y = "Lengd"
    ) +
    geom_point(color = 1, size = 2) +
    geom_point(aes(x = aldur, y = Meðallengd),taflac, color = 2, size = 3)
```

```{r, Kassarit sem sýnir lengd fiska eftir aldri}
  ah$aldur <- factor(ah$aldur)
  ggplot(ah,aes(x = aldur, y = le)) + labs(
        x = "Aldur",
        y = "Lengd"
    ) +
    geom_boxplot()
```
##!!!!!!!!!!!!Hér vantar að svara spurningum úr c lið!!!!!!!!!!!!!!!!!!!!
## d) liður
```{r, Tvö hafsvæði valin á slembin hátt, gerum töflu með 50 fiskum af hvoru gefnu hafsvæði}
set.seed(3110)
(svaedi<-sample(unique(hafsvaedi),2))
```
Við fáum sem sagt hafsvæðin "NV" og "NAu"
```{r, Tafla með 50 fiskum af hvoru gefnu hafsvæði}
hafsvaedi1 <- filter(ah, hafsvaedi == "NV")
hafsvaedi2 <- filter(ah, hafsvaedi == "NAu")
set.seed(3110)
fiskar1 <- sample_n(hafsvaedi1, 50, replace = F)
set.seed(3110)
fiskar2 <- sample_n(hafsvaedi2, 50, replace = F)
fiskar <- rbind(fiskar1, fiskar2)
fiskar
```

## e) liður
Við athugum nú hvort marktækur munur sé á meðallengd fiska á hafsvæðunum tveimur. Ef marktækur munur er á meðallengd fiska á hafsvæðunum tveimur myndum við þurfa að hafna tilgátuprófinu:

$$H_{0}: \mu_{NV} - \mu_{NAu} = 0\\
H_{1}: \mu_{NV} - \mu_{NAu} \neq 0$$

Forsendur fyrir því að tilgátuprófið gefi heilvita niðurstöðu er að gögnin séu normaldreifð og meðallengd fiska sé óháð hafsvæðunum tveimur. Framkvæmum nú t-próf með tvíhliða gagntilgátu og öryggið $1-\alpha = 0.95$.
```{r, tilgátupróf}
tilgatuprofe <- t.test(fiskar$le~fiskar$hafsvaedi)
tilgatuprofe
```
Niðurstöður úr t-prófinu gefa að prófstærðin er $-0.42463$ og p-gildið er $0.672$. Við höfnum ekki $H_{0}$ þar sem p-gildið er hærra en $\alpha$. Það er því ekki marktækur munur á meðallengd fiska á hafsvæðunum tveimur. Þá fáum við að $[-7.489194, 4.849194]$ er $95\%$ öryggisbil fyrir mismun meðaltalanna á hafsvæðunum tveimur. Við athugum sérstaklega að öryggisbilið inniheldur $0$ en það stafar af því að við gátum ekki hafnað núlltilgátunni. Það er sem sagt möguleiki á því að mismunur meðaltalanna sé 0.

## f) liður
Meðal forsenda fyrir því að tilgátuprófið að ofan (sjá e-lið) gefi heilvita niðurstöðu var að gögnin væru normaldreifð. Nú viljum við kanna að hvort sú forsenda eigi rétt á sér þ.e. hvort gögnin fylgi normaldreifingu. Teiknum stuðlarit af lengd fyrir hvert hafsvæði og teiknum inn á stuðlaritin (í rauðum lit) þéttleikafall þeirrar normaldreifingar sem eðlilegt væri að búast við að gögnin fyrir hvert hafsvæði fylgdu.
```{r}
# Skilgreinum fall sem ad tekur inn gagnavigur x og
#   skilar gognum sem fylgja "natturulegu" normaldreifingu vigursins x
get_normal_density <- function(x, binwidth) {
  grid <- seq(min(x), max(x), length=100)
  data.frame(
    le = grid,
    normal_curve = dnorm(grid, mean(x), sd(x)) * length(x) * binwidth
  )
}

# Skilgreinum breytu fyrir binwidth
BW <- 3

# Buum til normaldreifd gogn fyrir hvert hafsvaedi med thvi ad
#   beita fallinu "get_normal_density" a lengdarmaelingar sem tilheyra
#   hverju hafsvaedi fyrir sig
normaldens <-
  ah %>%
  group_by(hafsvaedi) %>%
  do(get_normal_density(x=.$le, binwidth=BW))

#Teiknum nú upp myndirnar fjórar ásamt tilsvarandi þéttleikaföllum
ah_long = melt(ah, id.vars='hafsvaedi', measure.vars='le', value.name='le')

ggplot(ah_long, aes(le)) +  geom_histogram(binwidth = 3) +
   geom_line(data = normaldens, aes(x = le, y = normal_curve),color="red") + xlab("Lengd") + ylab("Fjöldi") + facet_wrap(vars(hafsvaedi)) + labs(caption = "Fjögur stuðlarit af lengd fiska fyrir hvert hafsvæði.") + theme(plot.caption = element_text(hjust = 0.5))
```
Af stuðlaritunum fjórum sjáum við að hafsvæðin NV og SV eru nær því að vera normaldreifð en hafsvæðin NAu og SA sem þó falla nokkuð vel að normaldreifingu.

## g) liður

## h) liður

## i) liður

## j) liður

## k) liður

## Bónusspurning